{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <h1>Invoices</h1>
</div>

<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Period</th>
          <th>Amount</th>
          <th>Status</th>
          <th>File</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td>{{ inv.invoice_date }}</td>
          <td>
            {% if inv.customer_id in customers %}
            <strong>{{ customers[inv.customer_id].name }}</strong>
            {% else %}
            <span class="text-muted">Deleted Customer</span>
            {% endif %}
          </td>
          <td>{{ inv.period_label }}</td>
          <td>${{ "%.2f"|format(inv.amount) }}</td>
          <td>
            {% if inv.status == 'Paid' %}
            <span class="badge badge-success"
              style="background-color: #28a745; color: white; padding: 5px 10px; border-radius: 4px;">Paid</span>
            {% else %}
            <span class="badge badge-warning"
              style="background-color: #ffc107; color: black; padding: 5px 10px; border-radius: 4px;">Unpaid</span>
            {% endif %}
          </td>
          <td>
            <a href="{{ url_for('download_invoice', invoice_id=inv.id) }}" class="badge badge-blue">
              {{ inv.file_path }}
            </a>
          </td>
          <td>
            <button class="btn btn-sm btn-secondary"
              onclick="openEmailModal('{{ inv.email_subject|replace("'", "\\'") }}', '{{ inv.email_body|replace("'", "\\'")|replace('\n', '\\n') }}')">
              View Email
            </button>
            <form action="{{ url_for('toggle_invoice_status', invoice_id=inv.id) }}" method="post"
              style="display:inline;">
              <button type="submit" class="btn btn-sm btn-outline-secondary" style="margin-left: 5px;">
                {% if inv.status == 'Paid' %}Mark Unpaid{% else %}Mark Paid{% endif %}
              </button>
            </form>
            <form action="{{ url_for('delete_invoice', invoice_id=inv.id) }}" method="post" style="display:inline;"
              onsubmit="return confirm('Are you sure you want to delete this invoice?');">
              <button type="submit" class="btn btn-sm btn-danger" style="margin-left: 5px;">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Email Draft</h2>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Subject</label>
        <input type="text" id="modalSubject" readonly>
      </div>
      <div class="form-group">
        <label>Body</label>
        <textarea id="modalBody" readonly></textarea>
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-secondary" onclick="clearEmailDraft()">Clear</button>
      <button class="btn btn-primary" onclick="copyToClipboard()">Copy Body</button>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('emailModal');
  const subjectInput = document.getElementById('modalSubject');
  const bodyInput = document.getElementById('modalBody');

  function openEmailModal(subject, body) {
    subjectInput.value = subject;
    bodyInput.value = body;
    modal.classList.add('show');
  }

  function clearEmailDraft() {
    subjectInput.value = '';
    bodyInput.value = '';
  }

  function copyToClipboard() {
    bodyInput.select();
    document.execCommand('copy');
    alert('Email body copied to clipboard!');
  }

  // Close modal when clicking outside
  window.onclick = function (event) {
    if (event.target == modal) {
      modal.classList.remove('show');
    }
  }
</script>
{% endblock %}